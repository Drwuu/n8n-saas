services:
  n8n:
    environment:
      - WEBHOOK_URL=${WEBHOOK_URL}
    labels:
      # Override n8n router for HTTPS
      - "traefik.http.routers.n8n_${CLIENT_NAME}.entrypoints=websecure"
      - "traefik.http.routers.n8n_${CLIENT_NAME}.tls.certresolver=letsencrypt"
      - "traefik.http.routers.n8n_${CLIENT_NAME}.middlewares=security-headers@docker"
      # Security headers middleware
      - "traefik.http.middlewares.security-headers.headers.stsSeconds=31536000"
      - "traefik.http.middlewares.security-headers.headers.stsIncludeSubdomains=true"
      - "traefik.http.middlewares.security-headers.headers.stsPreload=true"
      - "traefik.http.middlewares.security-headers.headers.forceSTSHeader=true"
      - "traefik.http.middlewares.security-headers.headers.frameDeny=true"
      - "traefik.http.middlewares.security-headers.headers.contentTypeNosniff=true"
      - "traefik.http.middlewares.security-headers.headers.browserXssFilter=true"
      - "traefik.http.middlewares.security-headers.headers.referrerPolicy=strict-origin-when-cross-origin"
      - "traefik.http.middlewares.security-headers.headers.permissionsPolicy=geolocation=(), microphone=(), camera=()"

  # Backup service for PostgreSQL with Google Cloud Storage
  postgres-backup:
    image: google/cloud-sdk:alpine
    container_name: backup_${CLIENT_NAME}
    restart: "no"
    environment:
      - PGPASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_HOST=postgres
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_DB=${POSTGRES_DB}
      - GCS_BUCKET=${GCS_BACKUP_BUCKET}
      - GOOGLE_APPLICATION_CREDENTIALS=/gcs-key/service-account-key.json
    volumes:
      - ./backups:/backups
      - ./gcs-key:/gcs-key:ro
    command: >
      sh -c "
        apk add --no-cache postgresql18-client &&
        BACKUP_FILE=backup-${CLIENT_NAME}-$$(date +%Y%m%d-%H%M%S).dump &&
        pg_dump -h $$POSTGRES_HOST -U $$POSTGRES_USER -d $$POSTGRES_DB -Fc -f /backups/$$BACKUP_FILE &&
        echo 'Backup created: '$$BACKUP_FILE &&
        gcloud auth activate-service-account --key-file=$$GOOGLE_APPLICATION_CREDENTIALS &&
        gsutil cp /backups/$$BACKUP_FILE gs://$$GCS_BUCKET/n8n-backups/${CLIENT_NAME}/$$BACKUP_FILE &&
        echo 'Backup uploaded to GCS' &&
        find /backups -name 'backup-${CLIENT_NAME}-*.dump' -mtime +7 -delete &&
        gsutil -m rm gs://$$GCS_BUCKET/n8n-backups/${CLIENT_NAME}/**backup-${CLIENT_NAME}-*.dump --quiet || true
      "
    depends_on:
      - postgres
    networks:
      - internal
    profiles:
      - backup
